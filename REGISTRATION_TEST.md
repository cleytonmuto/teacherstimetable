# Teacher Registration Test Guide

This guide helps you verify that teacher registration is working correctly.

## Prerequisites

1. âœ… Firebase connection is working (test at `/firebase-status`)
2. âœ… Firestore Database is created
3. âœ… Email/Password authentication is enabled
4. âœ… Security rules are properly configured

## Security Rules Required for Registration

Make sure your Firestore security rules include:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow connection test
    match /_connection_test/{document=**} {
      allow read, write: if true;
    }
    
    // Users collection - registration and login
    match /users/{userId} {
      // Allow creating document if userId matches authenticated user's ID
      allow create: if request.auth != null && request.auth.uid == userId;
      // Allow reading own document
      allow read: if request.auth != null && request.auth.uid == userId;
      // Allow querying by CPF for login lookup (all authenticated users can query)
      allow read: if request.auth != null;
    }
    
    // Timetable collection
    match /timetable/{documentId} {
      allow read, write, delete: if request.auth != null && request.auth.uid == resource.data.teacherId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.teacherId;
    }
  }
}
```

## Testing Registration

### Step 1: Test with a Valid CPF

1. Navigate to the login page
2. Click "Cadastrar" (Register)
3. Enter a valid CPF (e.g., `12345678909`)
4. Enter a password (at least 6 characters)
5. Click "Cadastrar"

### Expected Behavior

1. âœ… CPF validation should show "CPF vÃ¡lido" when you enter 11 digits
2. âœ… Form submission should show loading state
3. âœ… Success message: "Cadastro realizado com sucesso! Redirecionando..."
4. âœ… Automatic redirect to dashboard after ~1.5 seconds
5. âœ… User should be logged in automatically
6. âœ… Dashboard should show the user's CPF in the header

### Step 2: Verify in Firebase Console

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project: **fir-react-5d6b7**
3. Go to **Authentication** > **Users**
4. Verify a new user was created (Firebase will show an internal identifier format)
5. Go to **Firestore Database** > **Data**
6. Navigate to `users` collection
7. Verify a document was created with:
   - Document ID: The user's Firebase Auth UID
   - Fields:
     - `userId`: Same as document ID
     - `cpf`: The CPF you entered (11 digits, no formatting)
     - `internalId`: Internal identifier (for Firebase Auth, not shown to users)
     - `createdAt`: Timestamp
     - `updatedAt`: Timestamp
   
   **Note**: The application only uses CPF for authentication. The internal identifier is automatically generated by the system and is not displayed to users.

### Step 3: Test Duplicate Registration

1. Try to register with the same CPF again
2. Expected: Error message "CPF jÃ¡ cadastrado. Use a opÃ§Ã£o de login."

### Step 4: Test Login After Registration

1. Logout from the dashboard
2. Go to login page
3. Enter the same CPF you registered with
4. Enter the same password
5. Click "Entrar"

### Expected Behavior

1. âœ… Successful login
2. âœ… Redirect to dashboard
3. âœ… CPF displayed in header

## Troubleshooting

### Issue: "Erro de permissÃ£o ao salvar dados"

**Solution:**
- Check Firestore security rules
- Ensure the rule allows creating documents where `userId == request.auth.uid`
- Verify the user is authenticated (check browser console for auth state)

### Issue: "CPF jÃ¡ cadastrado" but user doesn't exist

**Solution:**
- Check Firestore `users` collection for the CPF
- Verify the query is working correctly
- Check browser console for Firestore query errors

### Issue: Registration succeeds but user is not logged in

**Solution:**
- Check browser console for `onAuthStateChanged` messages
- Verify Firebase Auth user was created
- Check if there are any errors in the authentication flow
- Verify the `loadUserCPF` function is working

### Issue: Document created but data is incorrect

**Solution:**
- Check the document in Firestore Console
- Verify CPF formatting (should be 11 digits, no formatting)
- Check browser console logs for registration process
- Verify the `setDoc` call includes all required fields

## Browser Console Logs

During registration, you should see these logs in the browser console:

```
Creating Firebase Auth account for CPF: 12345678909
âœ… Firebase Auth account created: {userId}
Saving teacher data to Firestore...
âœ… Teacher data saved to Firestore
âœ… Registration completed successfully for CPF: 12345678909
ðŸ“„ User document ID: {userId}
ðŸ“„ User data: {userId, cpf, email, createdAt, updatedAt}
```

## Verification Checklist

- [ ] CPF validation works correctly
- [ ] Registration creates Firebase Auth user
- [ ] Registration creates Firestore document
- [ ] Document has correct structure
- [ ] User is automatically logged in after registration
- [ ] User is redirected to dashboard
- [ ] CPF is displayed in dashboard header
- [ ] Duplicate registration is prevented
- [ ] Login works after registration
- [ ] Error messages are user-friendly
- [ ] Success message is displayed

## Common CPF Test Values

For testing, you can use these valid CPF numbers:

- `12345678909` - Valid CPF
- `11144477735` - Valid CPF
- `00000000000` - Invalid (all same digits)
- `12345678901` - Invalid (wrong checksum)

## Next Steps

After verifying registration works:

1. Test the timetable functionality
2. Verify timetable entries are saved correctly
3. Test logout and login flow
4. Test with multiple users
5. Verify data isolation (users can only see their own data)
